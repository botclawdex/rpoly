<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>rPoly | BTC 5m Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lightweight-charts@5.1.0/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    :root {
      --bg: #0a0a0a;
      --card: #0d1117;
      --card-hover: #161b22;
      --green: #00ff41;
      --green-dim: #00cc33;
      --green-glow: rgba(0,255,65,0.12);
      --red: #ff3333;
      --red-glow: rgba(255,51,51,0.12);
      --yellow: #ffaa00;
      --text: #c9d1d9;
      --text-dim: #8b949e;
      --border: #1a2a1a;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:'JetBrains Mono',monospace;
      background:var(--bg);
      color:var(--text);
      min-height:100vh;
      line-height:1.5;
      overflow-y:scroll;
    }
    body::before {
      content:'';position:fixed;top:0;left:0;width:100%;height:100%;
      background:repeating-linear-gradient(0deg,rgba(0,0,0,0.1),rgba(0,0,0,0.1) 1px,transparent 1px,transparent 2px);
      pointer-events:none;z-index:1000;
    }

    .wrap { width:100%; padding:12px 24px; }

    /* Nav tabs */
    .nav-tab {
      display:inline-block; padding:5px 12px; font-size:10px; font-weight:600;
      letter-spacing:1px; text-transform:uppercase; text-decoration:none;
      color:var(--text-dim); border:1px solid transparent;
      transition:all .2s;
    }
    .nav-tab:hover { color:var(--green); background:rgba(0,255,65,0.05); border-color:rgba(0,255,65,0.15); }
    .nav-tab-active { color:var(--green); border-color:rgba(0,255,65,0.25); background:rgba(0,255,65,0.06); }

    /* Header */
    header {
      display:grid; grid-template-columns:1fr auto 1fr; align-items:center;
      padding:10px 24px; border-bottom:1px solid var(--border); margin-bottom:0;
    }
    header > div:last-child { justify-self:end; }
    .header-clock {
      display:flex; align-items:center; gap:6px;
      padding:4px 14px;
      background:rgba(0,255,65,0.04);
      border:1px solid rgba(0,255,65,0.15);
      border-radius:3px;
    }
    .clock-time {
      font-size:14px; font-weight:700; color:var(--green);
      letter-spacing:1.5px;
      text-shadow:0 0 8px rgba(0,255,65,0.5), 0 0 20px rgba(0,255,65,0.2);
    }
    .clock-label {
      font-size:9px; color:var(--text-dim); text-transform:uppercase;
      letter-spacing:1px; opacity:0.7;
    }
    .clock-sep {
      font-size:12px; color:rgba(0,255,65,0.3); margin:0 2px;
    }
    .logo { font-size:22px; font-weight:700; color:var(--green); }
    .logo span { color:var(--text); }
    .live-dot {
      width:6px;height:6px;border-radius:50%;
      display:inline-block; margin-right:4px;
    }
    .live-dot.on { background:var(--green); animation:pulse 2s infinite; }
    .live-dot.off { background:var(--red); }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }

    /* Grid */
    .grid { display:grid; gap:12px; margin-bottom:12px; }
    .grid-4 { grid-template-columns:1fr 1fr 1fr 1fr; }
    .grid-32 { grid-template-columns:3fr 2fr; }
    .grid-chart { grid-template-columns:1fr 320px; }

    /* Cards */
    .card {
      background:var(--card); border:1px solid var(--border); padding:14px;
      transition:border-color .2s;
    }
    .card:hover { border-color:#2a4a2a; }
    .card-label {
      font-size:10px; color:var(--text-dim); text-transform:uppercase;
      letter-spacing:1px; margin-bottom:6px;
    }
    .val { font-size:22px; font-weight:700; color:var(--green); }
    .val-lg { font-size:28px; font-weight:700; color:var(--green); }
    .val-sm { font-size:15px; font-weight:700; color:var(--green); }
    .sub { font-size:10px; color:var(--text-dim); margin-top:2px; }
    .up { color:var(--green); }
    .down { color:var(--red); }
    .neutral { color:var(--yellow); }

    /* Market Analysis panel */
    .ma-panel { display:flex; flex-direction:column; gap:10px; }
    .ma-section { border-top:1px solid var(--border); padding-top:8px; }
    .ma-section:first-child { border-top:none; padding-top:0; }
    .ma-section-label { font-size:8px; color:var(--text-dim); text-transform:uppercase; letter-spacing:1px; margin-bottom:4px; }

    /* Confidence arc */
    .conf-gauge { text-align:center; padding:4px 0; }
    .conf-gauge svg { display:block; margin:0 auto; }
    .conf-direction { font-size:20px; font-weight:900; letter-spacing:2px; }
    .conf-direction.up { color:var(--green); text-shadow:0 0 12px rgba(0,255,65,0.5); }
    .conf-direction.down { color:var(--red); text-shadow:0 0 12px rgba(255,50,50,0.5); }
    .conf-direction.neutral { color:var(--yellow); text-shadow:0 0 8px rgba(255,170,0,0.3); }
    .conf-pct { font-size:10px; color:var(--text-dim); margin-top:2px; }

    /* Sentiment bar */
    .sent-bar-wrap { display:flex; align-items:center; gap:6px; font-size:10px; font-weight:700; }
    .sent-bar { flex:1; height:6px; border-radius:3px; background:var(--card-bg); overflow:hidden; display:flex; }
    .sent-bar-up { background:var(--green); height:100%; transition:width .4s ease; }
    .sent-bar-dn { background:var(--red); height:100%; transition:width .4s ease; }
    .sent-mid { font-size:9px; color:var(--text-dim); text-align:center; margin-top:3px; }

    /* Depth bars */
    .depth-row { display:flex; align-items:center; gap:6px; font-size:10px; padding:2px 0; }
    .depth-label { width:28px; font-weight:700; font-size:9px; }
    .depth-price { width:40px; font-weight:700; }
    .depth-size { width:40px; color:var(--text-dim); font-size:9px; text-align:right; }
    .depth-bar-wrap { flex:1; height:4px; border-radius:2px; background:rgba(255,255,255,0.05); }
    .depth-bar-fill { height:100%; border-radius:2px; transition:width .4s ease; }

    /* Factor rows */
    .factor-row { display:flex; align-items:center; justify-content:space-between; font-size:10px; padding:2px 0; }
    .factor-label { color:var(--text-dim); width:70px; }
    .factor-value { font-weight:700; flex:1; text-align:center; }
    .factor-dots { display:flex; gap:2px; }
    .factor-dot { width:5px; height:5px; border-radius:50%; background:rgba(255,255,255,0.1); }
    .factor-dot.active { background:var(--green); box-shadow:0 0 4px rgba(0,255,65,0.4); }
    .factor-dot.active.bearish { background:var(--red); box-shadow:0 0 4px rgba(255,50,50,0.4); }

    /* Chart */
    .chart-header {
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:8px;
    }
    .interval-switch { display:flex; gap:2px; }
    .iv-btn {
      padding:4px 10px; font-family:inherit; font-size:10px; font-weight:700;
      background:var(--bg); border:1px solid var(--border); color:var(--text-dim);
      cursor:pointer; transition:all .15s;
    }
    .iv-btn:hover { border-color:var(--green); color:var(--text); }
    .iv-btn.active { border-color:var(--green); color:var(--green); background:var(--green-glow); }
    .chart-info {
      display:flex; justify-content:space-between; margin-top:6px;
      font-size:10px; color:var(--text-dim);
    }

    /* Orderbook mini */
    .ob-row { display:flex; justify-content:space-between; font-size:11px; padding:3px 0; }
    .ob-price { font-weight:700; }
    .ob-size { color:var(--text-dim); }
    .ob-bar { height:3px; margin-top:1px; border-radius:1px; }

    /* Markets table */
    .m-table { width:100%; border-collapse:collapse; }
    .m-table th {
      text-align:left; padding:8px; border-bottom:1px solid var(--border);
      color:var(--text-dim); font-size:10px; text-transform:uppercase; letter-spacing:1px;
    }
    .m-table td { padding:8px; border-bottom:1px solid var(--border); font-size:12px; }
    .m-table tr:hover { background:var(--card-hover); }
    .badge {
      display:inline-block; padding:2px 6px; font-size:9px; font-weight:700;
      border:1px solid;
    }
    .badge.open { color:var(--green); border-color:var(--green); background:var(--green-glow); }
    .badge.closed { color:var(--red); border-color:var(--red); background:var(--red-glow); }
    .badge.resolved { color:var(--yellow); border-color:var(--yellow); background:rgba(255,170,0,.1); }
    .prob-bar {
      display:flex; height:16px; border-radius:2px; overflow:hidden; font-size:9px;
      font-weight:700; line-height:16px; min-width:120px;
    }
    .prob-up { background:var(--green); color:var(--bg); text-align:center; }
    .prob-down { background:var(--red); color:#fff; text-align:center; }

    /* Countdown */
    .countdown { font-weight:700; font-size:12px; letter-spacing:0.5px; white-space:nowrap; }
    .countdown.urgent { animation:countBlink 1s infinite; }
    @keyframes countBlink { 0%,100%{opacity:1} 50%{opacity:.5} }

    /* Floating trade bubbles on chart */
    #flow-overlay {
      position:absolute; top:0; left:0; right:0; bottom:0;
      pointer-events:none; overflow:hidden; z-index:10;
    }
    .flow-bubble {
      position:absolute; left:50%; transform:translateX(-50%);
      padding:4px 14px; border-radius:20px;
      font-weight:700; white-space:nowrap;
      opacity:0; pointer-events:none;
    }
    .flow-bubble.trade { font-size:16px; animation:bubbleRise 4s ease-out forwards; }
    .flow-bubble.order { font-size:12px; animation:bubbleRiseQuick 2.8s ease-out forwards; }
    .flow-bubble.buy {
      color:var(--green);
      background:rgba(0,255,65,0.08);
      border:1px solid rgba(0,255,65,0.2);
    }
    .flow-bubble.sell {
      color:var(--red);
      background:rgba(255,51,51,0.08);
      border:1px solid rgba(255,51,51,0.2);
    }
    .flow-bubble.trade.buy { text-shadow:0 0 14px rgba(0,255,65,0.7), 0 0 30px rgba(0,255,65,0.3); }
    .flow-bubble.trade.sell { text-shadow:0 0 14px rgba(255,51,51,0.7), 0 0 30px rgba(255,51,51,0.3); }
    .flow-bubble.order.buy { text-shadow:0 0 6px rgba(0,255,65,0.3); }
    .flow-bubble.order.sell { text-shadow:0 0 6px rgba(255,51,51,0.3); }
    .flow-bubble .bubble-size {
      font-size:9px; font-weight:400; opacity:0.5; margin-left:5px;
    }
    @keyframes bubbleRise {
      0%   { bottom:8%; opacity:0; transform:translateX(-50%) scale(0.6); }
      8%   { opacity:0.95; transform:translateX(-50%) scale(1.05); }
      15%  { transform:translateX(-50%) scale(1); }
      65%  { opacity:0.7; }
      100% { bottom:88%; opacity:0; transform:translateX(-50%) scale(0.85); }
    }
    @keyframes bubbleRiseQuick {
      0%   { bottom:8%; opacity:0; transform:translateX(-50%) scale(0.6); }
      10%  { opacity:0.55; transform:translateX(-50%) scale(1); }
      60%  { opacity:0.35; }
      100% { bottom:70%; opacity:0; transform:translateX(-50%) scale(0.8); }
    }

    /* Toast */
    .toast {
      position:fixed; bottom:20px; right:20px; padding:12px 20px;
      background:var(--card); border:1px solid var(--green); color:var(--green);
      font-family:inherit; font-size:12px; z-index:9999;
      transform:translateY(100px); opacity:0; transition:all .3s;
    }
    .toast.show { transform:translateY(0); opacity:1; }
    .toast.error { border-color:var(--red); color:var(--red); }

    /* Ticker marquee */
    .ticker-strip {
      overflow:hidden; white-space:nowrap;
      border-bottom:1px solid var(--border);
      background:rgba(0,255,65,0.02);
      height:28px; line-height:28px;
      font-size:11px; position:relative;
    }
    .ticker-track {
      display:inline-block; white-space:nowrap;
      animation:tickerScroll var(--ticker-speed, 60s) linear infinite;
      padding-left:100%;
    }
    .ticker-strip:hover .ticker-track { animation-play-state:paused; }
    .ticker-item {
      display:inline; margin-right:40px;
    }
    .ticker-sep {
      display:inline; margin:0 16px; color:rgba(0,255,65,0.2); font-size:9px;
    }
    @keyframes tickerScroll {
      0%   { transform:translateX(0); }
      100% { transform:translateX(-50%); }
    }

    footer {
      margin-top:16px; padding:10px 0; border-top:1px solid var(--border);
      text-align:center; font-size:10px; color:var(--text-dim);
    }

    @media (max-width:1200px) {
      .grid-chart { grid-template-columns:1fr 280px; }
    }
    @media (max-width:900px) {
      .grid-4 { grid-template-columns:1fr 1fr !important; }
      .grid-chart { grid-template-columns:1fr; }
      #main-spark { height:260px !important; }
    }
    @media (max-width:600px) {
      .wrap { padding:8px 12px; }
      .grid-4 { grid-template-columns:1fr !important; }
      .val { font-size:18px; }
      .val-lg { font-size:22px; }
      #main-spark { height:200px !important; }
    }
  </style>
</head>
<body>
  <header>
    <div style="display:flex;align-items:center;gap:4px;">
      <div class="logo">r<span>Poly</span>_</div>
      <nav style="display:flex;gap:2px;margin-left:12px;">
        <a href="/" class="nav-tab nav-tab-active">Dashboard</a>
        <a href="/hub" class="nav-tab">Hub</a>
      </nav>
    </div>
    <div style="text-align:center;">
      <div class="header-clock" id="header-time">
        <span class="clock-time" id="utc-time">--:--:--</span>
        <span class="clock-label">UTC</span>
        <span class="clock-sep">|</span>
        <span class="clock-time" id="pl-time">--:--:--</span>
        <span class="clock-label">PL</span>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:6px;">
      <span class="live-dot off" id="ws-dot"></span>
      <span style="font-size:10px;color:var(--text-dim);" id="ws-label">CONNECTING</span>
    </div>
  </header>

  <!-- Ticker: Bot Feed + Brain Stats scrolling -->
  <div class="ticker-strip">
    <div class="ticker-track" id="ticker-track">
      <span class="ticker-item" style="color:var(--text-dim);">&#x1F916; Connecting to ClawBot... &nbsp;&nbsp; &#x1F9E0; Loading brain...</span>
    </div>
  </div>

<div class="wrap">
  <!-- Row 1: BTC + TradingView mini | Balances -->
  <div class="grid" style="grid-template-columns:1fr 1fr 1fr 1fr;gap:12px;margin-bottom:12px;">
    <div class="card" style="grid-column:span 1;">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;">
        <div class="val-lg" id="btc-price">--</div>
        <span class="val-lg" style="color:var(--green);">$BTC</span>
      </div>
      <div class="sub" id="btc-change">waiting for websocket...</div>
      <!-- Mini TradingView candlestick -->
      <div style="margin-top:8px;border-top:1px solid var(--border);padding-top:6px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
          <span style="font-size:8px;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px;">Candles</span>
          <div class="interval-switch" style="gap:1px;">
            <button class="iv-btn" data-iv="1s" onclick="switchInterval('1s')" style="padding:2px 6px;font-size:8px;">1s</button>
            <button class="iv-btn active" data-iv="1m" onclick="switchInterval('1m')" style="padding:2px 6px;font-size:8px;">1m</button>
            <button class="iv-btn" data-iv="5m" onclick="switchInterval('5m')" style="padding:2px 6px;font-size:8px;">5m</button>
          </div>
        </div>
        <div id="chart-container" style="height:120px;"></div>
      </div>
    </div>
    <!-- Balances & Portfolio -->
    <div class="card" style="display:flex;flex-direction:column;">
      <!-- Cash hero -->
      <div style="display:flex;align-items:center;justify-content:center;height:56px;margin-top:-10px;">
        <div class="val-lg" id="total-usdc" style="font-size:32px;">--</div>
      </div>
      <!-- Key metrics grid — same cell padding as Profile -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1px;background:var(--border);border-top:1px solid var(--border);border-bottom:1px solid var(--border);">
        <div style="background:var(--card);padding:10px 8px;text-align:center;">
          <div style="font-size:9px;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px;">Positions</div>
          <div style="font-size:16px;font-weight:700;color:var(--green);margin-top:2px;" id="positions-value">--</div>
        </div>
        <div style="background:var(--card);padding:10px 8px;text-align:center;">
          <div style="font-size:9px;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px;">Volume</div>
          <div style="font-size:16px;font-weight:700;color:var(--text);margin-top:2px;" id="total-volume">--</div>
        </div>
        <div style="background:var(--card);padding:10px 8px;text-align:center;">
          <div style="font-size:9px;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px;">Realized P/L</div>
          <div style="font-size:16px;font-weight:700;margin-top:2px;" id="realized-pnl">--</div>
        </div>
        <div style="background:var(--card);padding:10px 8px;text-align:center;">
          <div style="font-size:9px;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px;">Unrealized</div>
          <div style="font-size:16px;font-weight:700;margin-top:2px;" id="total-pnl">--</div>
        </div>
      </div>
      <!-- Footer — pushed to bottom -->
      <div style="margin-top:auto;padding-top:8px;">
        <div id="proxy-addr" style="font-size:9px;color:var(--green);text-align:center;opacity:0.6;cursor:pointer;transition:opacity .2s;" title="Click to copy full address" onclick="copyProxyAddr()"></div>
      </div>
      <span id="proxy-usdc" style="display:none;"></span>
      <span id="eoa-usdc" style="display:none;"></span>
    </div>

    <!-- Profile / Stats -->
    <div class="card" id="slot-2" style="display:flex;flex-direction:column;">
      <div id="profile-content" style="font-size:11px;flex:1;display:flex;flex-direction:column;">
        <div style="color:var(--text-dim);text-align:center;padding:10px 0;">Loading...</div>
      </div>
    </div>
    <canvas id="identicon-canvas" width="48" height="48" style="display:none;"></canvas>

    <!-- Activity Feed -->
    <div class="card" id="slot-3">
      <div id="activity-content" style="font-size:10px;max-height:200px;overflow-y:auto;">
        <div style="color:var(--text-dim);text-align:center;padding:10px 0;">Loading...</div>
      </div>
    </div>
  </div>

  <!-- Row 2: BIG Sparkline + Sidebar -->
  <div class="grid grid-chart">
    <!-- Main sparkline chart + floating trade flow -->
    <div class="card" style="position:relative;overflow:hidden;">
      <div class="card-label" style="display:flex;justify-content:space-between;">
        <span>BTC/USD Live Price</span>
        <span style="font-size:8px;color:var(--text-dim);" id="flow-status">waiting...</span>
      </div>
      <canvas id="main-spark" style="width:100%;height:360px;display:block;"></canvas>
      <div class="chart-info">
        <span id="spark-range">Collecting data from WebSocket...</span>
        <span id="spark-ticks">0 ticks</span>
      </div>
      <!-- Floating trade bubbles overlay -->
      <div id="flow-overlay"></div>
    </div>

    <!-- Sidebar: Market Analysis -->
    <div style="display:flex;flex-direction:column;">
      <div class="card" style="flex:1;display:flex;flex-direction:column;">
        <div class="card-label">Market Analysis</div>
        <div class="ma-panel" id="ma-panel">
          <div style="color:var(--text-dim);font-size:11px;text-align:center;padding:20px 0;">Loading...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Row 3: 5m Markets Table -->
  <div class="card">
    <div class="card-label">BTC 5-Minute Markets</div>
    <table class="m-table">
      <thead>
        <tr>
          <th>Market</th>
          <th style="text-align:center;">Price to Beat</th>
          <th style="text-align:center;">End (UTC / PL)</th>
          <th style="text-align:center;">Time Left</th>
          <th>Up / Down</th>
          <th>Volume</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="markets-body">
        <tr><td colspan="7" style="text-align:center;color:var(--text-dim);padding:20px;">Loading...</td></tr>
      </tbody>
    </table>
  </div>

  <footer>
    rPoly v2.1 | signatureType=2 GNOSIS_SAFE | <span id="last-update">--</span>
  </footer>
</div>

<div class="toast" id="toast"></div>

<script>
const API = '';
const { createChart, CandlestickSeries } = LightweightCharts;

// === STATS BASELINE SYSTEM ===
// Baseline: 7 real trades from Feb 19 session (4W/3L, +$0.19)
// On first API load, current stats are saved as offset in localStorage.
// Displayed = (current_API - offset) + baseline. New trades accumulate on top.
const STATS_BASELINE = {
  wins: 5, losses: 4, marketsTraded: 9,
  totalVolume: 18.08, realizedPnl: 0.08, totalPnl: 0.08, biggestWin: 0.45,
  worstTrade: 0.44, bestTrade: 0.45,
};
const BASELINE_ACTIVITY = [
  { type:"TRADE", side:"SELL", title:"BTC February 19, 3:30PM-3:45PM", usdcSize:1.29, timestamp: 1739991540 },
  { type:"TRADE", side:"BUY", title:"BTC February 19, 3:30PM-3:45PM", usdcSize:1.00, timestamp: 1739991480 },
  { type:"TRADE", side:"SELL", title:"BTC February 19, 3:35PM-3:40PM", usdcSize:0.60, timestamp: 1739991480 },
  { type:"TRADE", side:"BUY", title:"BTC February 19, 3:35PM-3:40PM", usdcSize:1.00, timestamp: 1739991420 },
  { type:"TRADE", side:"SELL", title:"BTC February 19, 3:30PM-3:35PM", usdcSize:0.63, timestamp: 1739990520 },
  { type:"TRADE", side:"BUY", title:"BTC February 19, 3:30PM-3:35PM", usdcSize:1.00, timestamp: 1739990460 },
  { type:"TRADE", side:"SELL", title:"BTC February 19, 3:15PM-3:30PM", usdcSize:1.40, timestamp: 1739990100 },
  { type:"TRADE", side:"BUY", title:"BTC February 19, 3:15PM-3:30PM", usdcSize:1.00, timestamp: 1739989980 },
  { type:"TRADE", side:"SELL", title:"BTC February 19, 3:20PM-3:25PM", usdcSize:1.33, timestamp: 1739989920 },
  { type:"TRADE", side:"BUY", title:"BTC February 19, 3:20PM-3:25PM", usdcSize:1.00, timestamp: 1739989860 },
  { type:"TRADE", side:"SELL", title:"BTC February 19, 3:10PM-3:15PM", usdcSize:0.56, timestamp: 1739989260 },
  { type:"TRADE", side:"BUY", title:"BTC February 19, 3:10PM-3:15PM", usdcSize:1.00, timestamp: 1739989200 },
  { type:"TRADE", side:"SELL", title:"BTC February 19, 3:00PM-3:15PM", usdcSize:1.18, timestamp: 1739989140 },
  { type:"TRADE", side:"BUY", title:"BTC February 19, 3:00PM-3:15PM", usdcSize:1.00, timestamp: 1739989020 },
  { type:"TRADE", side:"SELL", title:"BTC February 19, 3:05PM-3:10PM", usdcSize:0.64, timestamp: 1739988960 },
  { type:"TRADE", side:"BUY", title:"BTC February 19, 3:05PM-3:10PM", usdcSize:1.00, timestamp: 1739988900 },
  { type:"TRADE", side:"SELL", title:"BTC February 19, 3:00PM-3:05PM", usdcSize:1.45, timestamp: 1739988720 },
  { type:"TRADE", side:"BUY", title:"BTC February 19, 3:00PM-3:05PM", usdcSize:1.00, timestamp: 1739988660 },
];
const OFFSET_KEY = 'clawbot_stats_offset_v3';
function getStatsOffset() { try { return JSON.parse(localStorage.getItem(OFFSET_KEY)); } catch(e) { return null; } }
function saveStatsOffset(d) {
  const o = {
    wins: d.wins || 0, losses: d.losses || 0, marketsTraded: d.marketsTraded || 0,
    totalVolume: d.totalVolume || 0, realizedPnl: d.realizedPnl || 0, totalPnl: d.totalPnl || 0,
    activityCutoff: Math.floor(Date.now() / 1000), savedAt: Date.now(),
  };
  localStorage.setItem(OFFSET_KEY, JSON.stringify(o));
  return o;
}
function adjustProfileStats(d) {
  let o = getStatsOffset();
  if (!o) o = saveStatsOffset(d);
  const w = Math.max(0, (d.wins || 0) - o.wins) + STATS_BASELINE.wins;
  const l = Math.max(0, (d.losses || 0) - o.losses) + STATS_BASELINE.losses;
  const total = w + l;
  const newActivity = (d.activity || []).filter(function(a) { return a.timestamp > o.activityCutoff; });
  return {
    profile: d.profile, positions: d.positions, positionsValue: d.positionsValue,
    wins: w, losses: l,
    winRate: total > 0 ? Math.round(w / total * 100) : 0,
    marketsTraded: Math.max(0, (d.marketsTraded || 0) - o.marketsTraded) + STATS_BASELINE.marketsTraded,
    totalVolume: Math.max(0, (d.totalVolume || 0) - o.totalVolume) + STATS_BASELINE.totalVolume,
    realizedPnl: ((d.realizedPnl || 0) - o.realizedPnl) + STATS_BASELINE.realizedPnl,
    totalPnl: ((d.totalPnl || 0) - o.totalPnl) + STATS_BASELINE.totalPnl,
    biggestWin: STATS_BASELINE.biggestWin,
    activity: newActivity.concat(BASELINE_ACTIVITY).sort(function(a, b) { return b.timestamp - a.timestamp; }),
  };
}
const BRAIN_OFFSET_KEY = 'clawbot_brain_offset_v3';
function getBrainOffset() { try { return JSON.parse(localStorage.getItem(BRAIN_OFFSET_KEY)); } catch(e) { return null; } }
function saveBrainOffset(m) {
  const o = { wins: m.wins || 0, losses: m.losses || 0, totalTrades: m.totalTrades || 0,
    totalPnl: parseFloat(String(m.totalPnl).replace(/[+$]/g,'')) || 0, savedAt: Date.now() };
  localStorage.setItem(BRAIN_OFFSET_KEY, JSON.stringify(o));
  return o;
}
function adjustBrainMemory(m) {
  let o = getBrainOffset();
  if (!o) o = saveBrainOffset(m);
  const w = Math.max(0, (m.wins || 0) - o.wins) + STATS_BASELINE.wins;
  const l = Math.max(0, (m.losses || 0) - o.losses) + STATS_BASELINE.losses;
  const total = w + l;
  const rawPnl = parseFloat(String(m.totalPnl).replace(/[+$]/g,'')) || 0;
  const adjPnl = (rawPnl - o.totalPnl) + STATS_BASELINE.totalPnl;
  return {
    winRate: total > 0 ? (w / total * 100).toFixed(1) + '%' : '0%',
    wins: w, losses: l, totalTrades: total,
    todayTrades: m.todayTrades || 0,
    totalPnl: (adjPnl >= 0 ? '+' : '') + '$' + adjPnl.toFixed(2),
    todayPnl: m.todayPnl || '+$0.00',
    bestTrade: '$' + Math.max(STATS_BASELINE.bestTrade, parseFloat(String(m.bestTrade).replace('$','')) || 0).toFixed(2),
    worstTrade: '-$' + Math.max(STATS_BASELINE.worstTrade, Math.abs(parseFloat(String(m.worstTrade).replace(/[+$-]/g,'')) || 0)).toFixed(2),
    currentStreak: m.currentStreak || 0,
  };
}

function generateIdenticon(seed) {
  const c = document.getElementById('identicon-canvas');
  const ctx = c.getContext('2d');
  const size = 48, grid = 5, cell = size / grid;
  let hash = 0;
  for (let i = 0; i < seed.length; i++) hash = ((hash << 5) - hash + seed.charCodeAt(i)) | 0;
  const hue = Math.abs(hash) % 360;
  ctx.fillStyle = '#0a0e14';
  ctx.fillRect(0, 0, size, size);
  ctx.fillStyle = 'hsl(' + hue + ',70%,55%)';
  for (let x = 0; x < Math.ceil(grid / 2); x++) {
    for (let y = 0; y < grid; y++) {
      if (((hash >> ((x * grid + y) % 30)) & 1) === 1) {
        ctx.fillRect(x * cell, y * cell, cell, cell);
        ctx.fillRect((grid - 1 - x) * cell, y * cell, cell, cell);
      }
    }
  }
  return c.toDataURL();
}

function copyProxyAddr() {
  const el = document.getElementById('proxy-addr');
  const full = el.dataset.full;
  if (!full) return;
  navigator.clipboard.writeText(full).then(() => {
    const orig = el.textContent;
    el.textContent = 'copied!';
    el.style.opacity = '1';
    setTimeout(() => { el.textContent = orig; el.style.opacity = '0.6'; }, 1200);
  });
}

let chart = null;
let candleSeries = null;
let lastCandle = null;
let btcWs = null;
let currentInterval = '1m';
let chartRefreshTimer = null;
let dashData = null;
let lastBtcPrice = 0;
let btcPriceHistory = [];

const IV_SECONDS = { '1s': 1, '1m': 60, '5m': 300, '15m': 900 };
const IV_REFRESH = { '1s': 30000, '1m': 60000, '5m': 300000, '15m': 300000 };

// ===== CHART =====
function initChart() {
  const container = document.getElementById('chart-container');
  chart = createChart(container, {
    layout: {
      background: { color: '#0d1117' },
      textColor: '#8b949e',
      fontFamily: 'JetBrains Mono, monospace',
      fontSize: 10,
    },
    grid: {
      vertLines: { color: '#1a2a1a' },
      horzLines: { color: '#1a2a1a' },
    },
    crosshair: {
      vertLine: { color: '#00ff4140', labelBackgroundColor: '#161b22' },
      horzLine: { color: '#00ff4140', labelBackgroundColor: '#161b22' },
    },
    rightPriceScale: {
      borderColor: '#1a2a1a',
      scaleMargins: { top: 0.05, bottom: 0.05 },
    },
    timeScale: {
      borderColor: '#1a2a1a',
      timeVisible: true,
      secondsVisible: false,
    },
    handleScroll: true,
    handleScale: true,
  });

  candleSeries = chart.addSeries(CandlestickSeries, {
    upColor: '#00ff41',
    downColor: '#ff3333',
    borderUpColor: '#00ff41',
    borderDownColor: '#ff3333',
    wickUpColor: '#00ff4180',
    wickDownColor: '#ff333380',
  });

  chart.timeScale().fitContent();
}

function switchInterval(iv) {
  currentInterval = iv;
  document.querySelectorAll('.iv-btn').forEach(b => b.classList.toggle('active', b.dataset.iv === iv));
  chart.applyOptions({ timeScale: { secondsVisible: iv === '1s' } });
  loadChartData();
  clearInterval(chartRefreshTimer);
  chartRefreshTimer = setInterval(loadChartData, IV_REFRESH[iv]);
}

async function loadChartData() {
  try {
    const res = await fetch(API + '/api/chart?interval=' + currentInterval);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();
    if (!data.candles?.length) return;

    const candles = data.candles.map(c => ({
      time: Math.floor(c.t / 1000),
      open: c.o, high: c.h, low: c.l, close: c.c,
    }));

    candleSeries.setData(candles);
    chart.timeScale().fitContent();
    lastCandle = candles[candles.length - 1];

    const prices = data.candles.map(c => c.c);
    const span = { '1s': '5min', '1m': '2h', '5m': '8h', '15m': '24h' }[currentInterval];
    document.getElementById('chart-range').textContent =
      span + ' | $' + Math.min(...prices).toLocaleString() + ' - $' + Math.max(...prices).toLocaleString();
    document.getElementById('chart-source').textContent = data.source || '';
  } catch (e) {
    document.getElementById('chart-range').textContent = 'Error: ' + e.message;
  }
}

function updateChartWithTick(price, timestamp) {
  if (!candleSeries || !lastCandle) return;
  const sec = IV_SECONDS[currentInterval] || 1;
  const candleTime = Math.floor(timestamp / sec) * sec;

  if (candleTime > lastCandle.time) {
    lastCandle = { time: candleTime, open: price, high: price, low: price, close: price };
  } else {
    lastCandle = {
      ...lastCandle,
      time: candleTime || lastCandle.time,
      high: Math.max(lastCandle.high, price),
      low: Math.min(lastCandle.low, price),
      close: price,
    };
  }
  candleSeries.update(lastCandle);
}

// ===== LIVE BTC (RTDS WebSocket) =====
function connectBtcWs() {
  const dot = document.getElementById('ws-dot');
  const label = document.getElementById('ws-label');

  btcWs = new WebSocket('wss://ws-live-data.polymarket.com');

  btcWs.onopen = () => {
    dot.className = 'live-dot on';
    label.textContent = 'LIVE';
    btcWs.send(JSON.stringify({
      action: 'subscribe',
      subscriptions: [{ topic: 'crypto_prices', type: 'update' }],
    }));
  };

  btcWs.onmessage = (event) => {
    try {
      const msg = JSON.parse(event.data);
      if (msg.payload?.symbol === 'btcusdt') {
        const price = msg.payload.value;
        const ts = Math.floor(msg.payload.timestamp / 1000);
        updateBtcPrice(price);
        updateChartWithTick(price, ts);
      }
    } catch (e) {}
  };

  btcWs.onclose = () => {
    dot.className = 'live-dot off';
    label.textContent = 'RECONNECTING';
    setTimeout(connectBtcWs, 3000);
  };

  setInterval(() => {
    if (btcWs && btcWs.readyState === WebSocket.OPEN) btcWs.send('ping');
  }, 5000);
}

function updateBtcPrice(price) {
  const el = document.getElementById('btc-price');
  const chEl = document.getElementById('btc-change');
  const prev = lastBtcPrice;
  lastBtcPrice = price;

  btcPriceHistory.push(price);
  if (btcPriceHistory.length > 200) btcPriceHistory.shift();

  el.textContent = '$' + price.toLocaleString(undefined, { maximumFractionDigits: 0 });
  el.style.textShadow = price > prev ? '0 0 10px var(--green)' : price < prev ? '0 0 10px var(--red)' : 'none';
  setTimeout(() => { el.style.textShadow = 'none'; }, 250);

  if (prev > 0) {
    const pct = ((price - prev) / prev * 100);
    chEl.textContent = (pct >= 0 ? '+' : '') + pct.toFixed(4) + '% (live)';
    chEl.className = 'sub ' + (pct >= 0 ? 'up' : 'down');
  }

  if (btcPriceHistory.length % 2 === 0) drawMainSpark();
}

function drawMainSpark() {
  const canvas = document.getElementById('main-spark');
  if (!canvas || btcPriceHistory.length < 2) return;
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const W = canvas.clientWidth || 600;
  const H = canvas.clientHeight || 360;
  canvas.width = W * dpr;
  canvas.height = H * dpr;
  canvas.style.width = W + 'px';
  canvas.style.height = H + 'px';
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  ctx.clearRect(0, 0, W, H);

  const prices = btcPriceHistory;
  const min = Math.min(...prices);
  const max = Math.max(...prices);
  const range = max - min || 1;
  const pad = 30;
  const goingUp = prices[prices.length - 1] >= prices[0];
  const lineColor = goingUp ? '#00ff41' : '#ff3333';

  // Horizontal grid + price labels
  ctx.font = '10px JetBrains Mono, monospace';
  ctx.textAlign = 'right';
  for (let i = 0; i < 6; i++) {
    const y = pad + (H - 2 * pad) * i / 5;
    const price = max - (range * i / 5);
    ctx.strokeStyle = '#1a2a1a';
    ctx.lineWidth = 0.5;
    ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W - 55, y); ctx.stroke();
    ctx.fillStyle = '#8b949e';
    ctx.fillText('$' + price.toFixed(0), W - 4, y + 3);
  }

  // Main price line
  ctx.beginPath();
  ctx.strokeStyle = lineColor;
  ctx.lineWidth = 2;
  ctx.shadowColor = goingUp ? 'rgba(0,255,65,0.4)' : 'rgba(255,51,51,0.4)';
  ctx.shadowBlur = 6;

  const chartW = W - 60;
  for (let i = 0; i < prices.length; i++) {
    const x = (i / (prices.length - 1)) * chartW;
    const y = pad + (1 - (prices[i] - min) / range) * (H - 2 * pad);
    if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
  }
  ctx.stroke();

  // Fill gradient
  ctx.shadowBlur = 0;
  const lastY = pad + (1 - (prices[prices.length - 1] - min) / range) * (H - 2 * pad);
  ctx.lineTo(chartW, H);
  ctx.lineTo(0, H);
  ctx.closePath();
  const grad = ctx.createLinearGradient(0, 0, 0, H);
  grad.addColorStop(0, goingUp ? 'rgba(0,255,65,0.12)' : 'rgba(255,51,51,0.12)');
  grad.addColorStop(1, 'rgba(0,0,0,0)');
  ctx.fillStyle = grad;
  ctx.fill();

  // Current price dot
  ctx.beginPath();
  ctx.arc(chartW, lastY, 5, 0, Math.PI * 2);
  ctx.fillStyle = lineColor;
  ctx.shadowColor = lineColor;
  ctx.shadowBlur = 10;
  ctx.fill();
  ctx.shadowBlur = 0;

  // Current price label
  ctx.fillStyle = '#0d1117';
  ctx.strokeStyle = lineColor;
  ctx.lineWidth = 1;
  const labelY = Math.max(pad, Math.min(H - pad - 10, lastY));
  ctx.fillRect(chartW + 4, labelY - 9, 52, 18);
  ctx.strokeRect(chartW + 4, labelY - 9, 52, 18);
  ctx.fillStyle = lineColor;
  ctx.font = '10px JetBrains Mono, monospace';
  ctx.textAlign = 'left';
  ctx.fillText('$' + prices[prices.length - 1].toFixed(0), chartW + 8, labelY + 4);

  // Info
  document.getElementById('spark-range').textContent =
    '$' + min.toLocaleString() + ' - $' + max.toLocaleString() + ' | ' +
    (goingUp ? '+' : '') + ((prices[prices.length-1] - prices[0]) / prices[0] * 100).toFixed(4) + '%';
  document.getElementById('spark-ticks').textContent = prices.length + ' ticks';
}

// ===== DASHBOARD DATA =====
async function loadDashboard() {
  try {
    const res = await fetch(API + '/api/dashboard');
    if (!res.ok) throw new Error('HTTP ' + res.status);
    dashData = await res.json();
    renderDashboard(dashData);
    document.getElementById('last-update').textContent = new Date().toLocaleTimeString();

    if (dashData.mode === 'readonly') {
      document.getElementById('ws-label').textContent = 'READONLY';
    }

    // BTC price fallback
    if (lastBtcPrice === 0 && dashData.btc?.price > 0) {
      document.getElementById('btc-price').textContent = '$' + dashData.btc.price.toLocaleString(undefined, { maximumFractionDigits: 0 });
      document.getElementById('btc-change').textContent = (dashData.btc.change24h >= 0 ? '+' : '') + (dashData.btc.change24h || 0).toFixed(2) + '% 24h';
    }
  } catch (e) {
    console.error('[dashboard]', e);
  }
}

function renderDashboard(d) {
  if (!d) return;
  const b = d.balances || {};

  document.getElementById('proxy-usdc').textContent = '$' + (b.proxy?.usdc || 0).toFixed(2);
  const pa = b.proxy?.address || '';
  const addrEl = document.getElementById('proxy-addr');
  addrEl.textContent = pa.length > 10 ? pa.slice(0,6) + '...' + pa.slice(-4) : 'not set';
  addrEl.dataset.full = pa;
  document.getElementById('eoa-usdc').textContent = '$' + (b.eoa?.usdc || 0).toFixed(2);
  document.getElementById('total-usdc').textContent = '$' + (b.totalUsdc || 0).toFixed(2);

  // Market Analysis panel
  renderMarketAnalysis(d);
}

// ===== MARKET ANALYSIS PANEL =====
function renderMarketAnalysis(d) {
  const panel = document.getElementById('ma-panel');
  const s = d.signal || {};
  const dir = s.direction || 'NO_MARKET';
  const conf = s.confidence || 0;
  const ob = d.orderbook;
  const m = d.market;

  if (dir === 'NO_MARKET' || !m) {
    panel.innerHTML = '<div style="color:var(--text-dim);font-size:11px;text-align:center;padding:20px 0;">No active market</div>';
    return;
  }

  const dirCls = dir === 'UP' ? 'up' : dir === 'DOWN' ? 'down' : 'neutral';
  const upPct = Math.round((m.upPrice || 0) * 100);
  const dnPct = Math.round((m.downPrice || 0) * 100);

  // SVG confidence arc
  const radius = 38;
  const circ = Math.PI * radius;
  const arcLen = (conf / 100) * circ;
  const arcColor = dir === 'UP' ? '#00ff41' : dir === 'DOWN' ? '#ff3232' : '#ffaa00';
  const arcGlow = dir === 'UP' ? 'rgba(0,255,65,0.4)' : dir === 'DOWN' ? 'rgba(255,50,50,0.4)' : 'rgba(255,170,0,0.3)';

  let html = '';

  // Market name + price to beat
  html += '<div style="font-size:9px;color:var(--text-dim);text-align:center;line-height:1.3;">' + m.question + '</div>';
  if (m.priceToBeat) {
    const btcNow = d.btc?.price || 0;
    const diff = btcNow - m.priceToBeat;
    const isUp = diff >= 0;
    const diffColor = isUp ? 'var(--green)' : 'var(--red)';
    const arrow = isUp ? '▲' : '▼';
    html += '<div style="display:flex;justify-content:center;gap:12px;margin:4px 0;font-size:10px;">';
    html += '<span style="color:var(--yellow);">Beat: $' + m.priceToBeat.toLocaleString('en',{minimumFractionDigits:2}) + '</span>';
    html += '<span style="color:' + diffColor + ';">' + arrow + ' ' + (isUp ? '+' : '') + '$' + Math.abs(diff).toFixed(2) + '</span>';
    html += '</div>';
  }

  // Confidence gauge
  html += '<div class="conf-gauge">';
  html += '<svg width="100" height="58" viewBox="0 0 100 58">';
  html += '<path d="M 10 52 A 38 38 0 0 1 90 52" fill="none" stroke="rgba(255,255,255,0.06)" stroke-width="5" stroke-linecap="round"/>';
  html += '<path d="M 10 52 A 38 38 0 0 1 90 52" fill="none" stroke="' + arcColor + '" stroke-width="5" stroke-linecap="round"';
  html += ' stroke-dasharray="' + arcLen.toFixed(1) + ' ' + circ.toFixed(1) + '"';
  html += ' style="filter:drop-shadow(0 0 4px ' + arcGlow + ');transition:stroke-dasharray .6s ease"/>';
  html += '<text x="50" y="38" text-anchor="middle" fill="' + arcColor + '" font-size="10" font-weight="900" font-family="JetBrains Mono,monospace">' + dir + '</text>';
  html += '<text x="50" y="50" text-anchor="middle" fill="rgba(255,255,255,0.4)" font-size="8" font-family="JetBrains Mono,monospace">' + conf + '% confidence</text>';
  html += '</svg>';
  html += '</div>';

  // Sentiment bar
  html += '<div class="ma-section">';
  html += '<div class="sent-bar-wrap">';
  html += '<span class="up">' + upPct + '%</span>';
  html += '<div class="sent-bar">';
  html += '<div class="sent-bar-up" style="width:' + upPct + '%"></div>';
  html += '<div class="sent-bar-dn" style="width:' + dnPct + '%"></div>';
  html += '</div>';
  html += '<span class="down">' + dnPct + '%</span>';
  html += '</div>';

  // Midpoint + spread
  const midStr = s.midpoint != null ? s.midpoint.toFixed(2) : '--';
  const sprStr = s.spread != null ? s.spread.toFixed(3) : '--';
  html += '<div class="sent-mid">Mid: ' + midStr + '  |  Spread: ' + sprStr + '</div>';
  html += '</div>';

  // Orderbook depth
  html += '<div class="ma-section">';
  html += '<div class="ma-section-label">Orderbook</div>';
  if (ob && (ob.bestAsk || ob.bestBid)) {
    const maxDepth = Math.max(ob.askDepth || 1, ob.bidDepth || 1);
    const askW = Math.round(((ob.askDepth || 0) / maxDepth) * 100);
    const bidW = Math.round(((ob.bidDepth || 0) / maxDepth) * 100);

    if (ob.bestAsk) {
      html += '<div class="depth-row">';
      html += '<span class="depth-label down">ASK</span>';
      html += '<span class="depth-price down">$' + ob.bestAsk.price + '</span>';
      html += '<div class="depth-bar-wrap"><div class="depth-bar-fill" style="width:' + askW + '%;background:var(--red);"></div></div>';
      html += '<span class="depth-size">' + parseFloat(ob.bestAsk.size).toFixed(0) + 'sh</span>';
      html += '</div>';
    }
    if (ob.bestBid) {
      html += '<div class="depth-row">';
      html += '<span class="depth-label up">BID</span>';
      html += '<span class="depth-price up">$' + ob.bestBid.price + '</span>';
      html += '<div class="depth-bar-wrap"><div class="depth-bar-fill" style="width:' + bidW + '%;background:var(--green);"></div></div>';
      html += '<span class="depth-size">' + parseFloat(ob.bestBid.size).toFixed(0) + 'sh</span>';
      html += '</div>';
    }
    html += '<div style="font-size:9px;color:var(--text-dim);margin-top:2px;">' + (ob.askDepth||0) + ' asks / ' + (ob.bidDepth||0) + ' bids  |  Vol: $' + ((m.volume||0)/1000).toFixed(1) + 'K</div>';
  } else {
    html += '<div style="font-size:10px;color:var(--text-dim);">No orderbook data</div>';
  }
  html += '</div>';

  // Factors
  const factors = s.factors || {};
  const fKeys = Object.keys(factors);
  if (fKeys.length > 0) {
    html += '<div class="ma-section">';
    html += '<div class="ma-section-label">Factors</div>';
    fKeys.forEach(function(k) {
      const f = factors[k];
      const isBear = f.bias === 'DOWN' || f.bias === 'SELL';
      let valStr = '';
      if (k === 'marketSkew') valStr = '<span class="' + (f.bias === 'UP' ? 'up' : f.bias === 'DOWN' ? 'down' : 'neutral') + '">' + f.pct + '% ' + f.bias + '</span>';
      else if (k === 'btcTrend') valStr = '<span class="' + (f.bias === 'UP' ? 'up' : f.bias === 'DOWN' ? 'down' : '') + '">' + (f.value > 0 ? '+' : '') + f.value.toFixed(1) + '%</span>';
      else if (k === 'volume') valStr = '$' + (f.value/1000).toFixed(1) + 'K';
      else if (k === 'bookDepth') valStr = '<span class="' + (f.bias === 'BUY' ? 'up' : f.bias === 'SELL' ? 'down' : '') + '">' + f.bias + ' ' + (f.bidDepth||0) + '/' + (f.askDepth||0) + '</span>';

      let dots = '';
      for (let i = 0; i < 5; i++) {
        dots += '<div class="factor-dot' + (i < (f.strength||0) ? ' active' + (isBear ? ' bearish' : '') : '') + '"></div>';
      }

      html += '<div class="factor-row">';
      html += '<span class="factor-label">' + f.label + '</span>';
      html += '<span class="factor-value">' + valStr + '</span>';
      html += '<span class="factor-dots">' + dots + '</span>';
      html += '</div>';
    });
    html += '</div>';
  }

  panel.innerHTML = html;
}

// ===== MARKETS TABLE =====
let marketsData = [];

function parseEndTimeET(question) {
  const m = question.match(/(\w+)\s+(\d+),.*?-(\d{1,2}):(\d{2})(AM|PM)\s+ET/);
  if (!m) return null;
  const months = {January:0,February:1,March:2,April:3,May:4,June:5,July:6,August:7,September:8,October:9,November:10,December:11};
  const month = months[m[1]];
  if (month === undefined) return null;
  const day = parseInt(m[2]);
  let hours = parseInt(m[3]);
  const minutes = parseInt(m[4]);
  const ampm = m[5];
  if (ampm === 'PM' && hours !== 12) hours += 12;
  if (ampm === 'AM' && hours === 12) hours = 0;
  const year = new Date().getFullYear();
  return new Date(Date.UTC(year, month, day, hours + 5, minutes, 0));
}

function getCountdownStr(question) {
  const end = parseEndTimeET(question);
  if (!end) return { text: '--', color: 'var(--text-dim)', urgent: false };
  const diff = Math.floor((end - Date.now()) / 1000);
  if (diff <= 0) return { text: 'ENDED', color: 'var(--red)', urgent: false };
  const mm = Math.floor(diff / 60);
  const ss = diff % 60;
  const color = diff < 60 ? 'var(--red)' : diff < 180 ? 'var(--yellow)' : 'var(--green)';
  return { text: mm + ':' + String(ss).padStart(2, '0'), color, urgent: diff < 60 };
}

function updateCountdowns() {
  document.querySelectorAll('.countdown-cell').forEach(cell => {
    const q = cell.getAttribute('data-q');
    const c = getCountdownStr(q);
    cell.innerHTML = '<span class="countdown' + (c.urgent ? ' urgent' : '') + '" style="color:' + c.color + ';">' + c.text + '</span>';
  });
}
setInterval(updateCountdowns, 1000);

async function loadMarkets() {
  try {
    const res = await fetch(API + '/api/markets/5m');
    const data = await res.json();
    const tbody = document.getElementById('markets-body');
    marketsData = data.markets || [];

    if (!marketsData.length) {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--text-dim);padding:20px;">No markets</td></tr>';
      return;
    }

    tbody.innerHTML = marketsData.map(m => {
      const upPct = (m.upPrice * 100).toFixed(0);
      const downPct = (m.downPrice * 100).toFixed(0);
      const status = m.resolved ? 'resolved' : m.closed ? 'closed' : 'open';
      const statusLabel = m.resolved ? 'RESOLVED' : m.closed ? 'CLOSED' : 'OPEN';
      const q = (m.question || '').replace(/"/g, '&quot;');
      const endUTC = parseEndTimeET(m.question);
      let timeCol = '<span style="color:var(--text-dim);">--</span>';
      if (endUTC) {
        const utcStr = endUTC.toLocaleTimeString('en-GB', { timeZone:'UTC', hour:'2-digit', minute:'2-digit' });
        const plStr = endUTC.toLocaleTimeString('pl-PL', { timeZone:'Europe/Warsaw', hour:'2-digit', minute:'2-digit' });
        timeCol = '<span style="color:var(--text);">' + utcStr + '</span>' +
          '<span style="color:var(--text-dim);margin:0 3px;">/</span>' +
          '<span style="color:var(--green);">' + plStr + '</span>';
      }
      const ptbCol = m.priceToBeat
        ? '<span style="color:var(--yellow);font-weight:700;">$' + m.priceToBeat.toLocaleString('en',{minimumFractionDigits:2,maximumFractionDigits:2}) + '</span>'
        : '<span style="color:var(--text-dim);">--</span>';
      return '<tr>' +
        '<td style="font-weight:500;">' + m.question + '</td>' +
        '<td style="text-align:center;white-space:nowrap;font-size:11px;">' + ptbCol + '</td>' +
        '<td style="text-align:center;white-space:nowrap;font-size:11px;">' + timeCol + '</td>' +
        '<td class="countdown-cell" data-q="' + q + '" style="text-align:center;">--</td>' +
        '<td><div class="prob-bar"><div class="prob-up" style="width:' + upPct + '%">' + upPct + '</div><div class="prob-down" style="width:' + downPct + '%">' + downPct + '</div></div></td>' +
        '<td style="color:var(--text-dim);">$' + (m.volume/1000).toFixed(1) + 'K</td>' +
        '<td><span class="badge ' + status + '">' + statusLabel + '</span></td>' +
      '</tr>';
    }).join('');

    updateCountdowns();
    maybeConnectMarketWs();
  } catch (e) {
    console.error('Markets:', e);
  }
}

// ===== LIVE TRADE FLOW (CLOB WebSocket) =====
let marketWs = null;
let marketWsTokens = [];
let flowQueue = [];
let flowBusy = false;

function maybeConnectMarketWs() {
  const open = marketsData.find(m => !m.closed && !m.resolved && m.tokenIds?.length > 0);
  if (!open) return;
  const tokens = open.tokenIds;
  if (JSON.stringify(tokens) === JSON.stringify(marketWsTokens)) return;
  if (marketWs) { marketWs.close(); marketWs = null; }
  connectMarketWs(tokens, open.conditionId);
}

function connectMarketWs(tokenIds, conditionId) {
  marketWsTokens = tokenIds;
  const statusEl = document.getElementById('flow-status');
  statusEl.textContent = 'connecting...';

  marketWs = new WebSocket('wss://ws-subscriptions-clob.polymarket.com/ws/market');

  marketWs.onopen = () => {
    statusEl.textContent = 'LIVE';
    statusEl.style.color = 'var(--green)';
    marketWs.send(JSON.stringify({
      assets_ids: tokenIds,
      type: 'MARKET',
    }));
  };

  let wsEventCount = 0;

  marketWs.onmessage = (event) => {
    try {
      const msgs = JSON.parse(event.data);
      const arr = Array.isArray(msgs) ? msgs : [msgs];
      arr.forEach(msg => {
        wsEventCount++;
        statusEl.textContent = 'LIVE (' + wsEventCount + ')';

        if (msg.event_type === 'last_trade_price') {
          const sz = parseFloat(msg.size) || 0;
          const px = parseFloat(msg.price) || 0;
          addFlowEntry({
            side: msg.side || 'BUY',
            amount: sz * px,
            price: px,
            size: sz,
            type: 'trade',
          });
        } else if (msg.event_type === 'price_change' && msg.price_changes?.length > 0) {
          msg.price_changes.forEach(pc => {
            const px = parseFloat(pc.price) || 0;
            const bestBid = parseFloat(pc.best_bid) || 0;
            const bestAsk = parseFloat(pc.best_ask) || 0;
            if (px > 0) {
              addFlowEntry({
                side: pc.side || 'BUY',
                amount: px,
                price: px,
                size: 0,
                type: 'order',
                bestBid, bestAsk,
              });
            }
          });
        }
      });
    } catch (e) {}
  };

  marketWs.onclose = () => {
    statusEl.textContent = 'reconnecting...';
    statusEl.style.color = 'var(--yellow)';
    setTimeout(() => {
      if (marketWsTokens.length > 0) connectMarketWs(marketWsTokens, conditionId);
    }, 3000);
  };
}

function addFlowEntry(entry) {
  flowQueue.push(entry);
  processFlowQueue();
}

function processFlowQueue() {
  if (flowBusy || !flowQueue.length) return;
  flowBusy = true;
  const entry = flowQueue.shift();
  spawnBubble(entry);
  const delay = entry.type === 'trade' ? 600 : 350;
  setTimeout(() => {
    flowBusy = false;
    processFlowQueue();
  }, delay);
}

function spawnBubble(entry) {
  const overlay = document.getElementById('flow-overlay');
  if (!overlay) return;
  const isBuy = entry.side === 'BUY';
  const sign = isBuy ? '+' : '-';
  const sideClass = isBuy ? 'buy' : 'sell';
  const typeClass = entry.type === 'trade' ? 'trade' : 'order';
  const offsetX = (Math.random() * 60 - 30).toFixed(0);
  const lifetime = entry.type === 'trade' ? 4100 : 2900;

  const el = document.createElement('div');
  el.className = 'flow-bubble ' + typeClass + ' ' + sideClass;
  el.style.left = 'calc(50% + ' + offsetX + 'px)';

  if (entry.type === 'trade') {
    el.innerHTML = sign + ' $' + entry.amount.toFixed(2) +
      '<span class="bubble-size">' + entry.size.toFixed(0) + 'sh</span>';
  } else {
    const pct = (entry.price * 100).toFixed(0);
    el.innerHTML = (isBuy ? 'BID' : 'ASK') + ' ' + pct + '\u00A2';
  }

  overlay.appendChild(el);
  setTimeout(() => el.remove(), lifetime);
}

// ===== HEADER CLOCK =====
function updateClock() {
  const now = new Date();
  const utc = now.toLocaleTimeString('en-GB', { timeZone: 'UTC', hour: '2-digit', minute: '2-digit', second: '2-digit' });
  const pl = now.toLocaleTimeString('pl-PL', { timeZone: 'Europe/Warsaw', hour: '2-digit', minute: '2-digit', second: '2-digit' });
  document.getElementById('utc-time').textContent = utc;
  document.getElementById('pl-time').textContent = pl;
}
setInterval(updateClock, 1000);
updateClock();

// ===== PROFILE & ACTIVITY =====
async function loadProfile() {
  try {
    const res = await fetch(API + '/api/profile');
    if (!res.ok) return;
    const raw = await res.json();
    const d = adjustProfileStats(raw);

    // Portfolio numbers
    document.getElementById('positions-value').textContent = '$' + (d.positionsValue || 0).toFixed(2);
    document.getElementById('total-volume').textContent = '$' + (d.totalVolume || 0).toFixed(2);

    const rpnl = d.realizedPnl || 0;
    const rpnlEl = document.getElementById('realized-pnl');
    rpnlEl.textContent = (rpnl >= 0 ? '+' : '') + '$' + rpnl.toFixed(2);
    rpnlEl.style.color = rpnl >= 0 ? 'var(--green)' : 'var(--red)';

    const totalPnlVal = d.totalPnl || 0;
    const upnl = totalPnlVal - rpnl;
    const upnlEl = document.getElementById('total-pnl');
    upnlEl.textContent = (upnl >= 0 ? '+' : '') + '$' + upnl.toFixed(2);
    upnlEl.style.color = upnl >= 0 ? 'var(--green)' : 'var(--red)';

    // Profile card
    const pc = document.getElementById('profile-content');
    if (d.profile) {
      const joined = d.profile.createdAt ? new Date(d.profile.createdAt).toLocaleDateString('en', { month: 'short', year: 'numeric' }) : '?';
      const wr = d.winRate || 0;
      const wrColor = wr >= 60 ? 'var(--green)' : wr >= 40 ? 'var(--yellow)' : 'var(--red)';
      const totalPL = totalPnlVal;
      const plColor = totalPL >= 0 ? 'var(--green)' : 'var(--red)';
      const avatarUrl = d.profile.image || generateIdenticon(d.profile.name || 'anon');

      pc.innerHTML =
        // Header: avatar + name — fixed 56px to match Portfolio hero
        '<div style="display:flex;align-items:center;gap:10px;height:56px;margin-top:-6px;">' +
          '<img src="' + avatarUrl + '" style="width:40px;height:40px;border-radius:50%;border:2px solid var(--green);background:var(--bg);" onerror="this.style.display=\'none\'">' +
          '<div>' +
            '<div style="font-weight:700;font-size:15px;color:var(--green);">' + d.profile.name +
              (d.profile.verified ? ' <span style="font-size:10px;">&#10003;</span>' : '') +
            '</div>' +
            '<div style="font-size:9px;color:var(--text-dim);">Joined ' + joined + '</div>' +
          '</div>' +
        '</div>' +
        // Stats grid 2x2 — same padding as Portfolio grid
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:1px;background:var(--border);border-top:1px solid var(--border);border-bottom:1px solid var(--border);">' +
          '<div style="background:var(--card);padding:10px 8px;text-align:center;">' +
            '<div style="font-size:9px;color:var(--text-dim);letter-spacing:1px;">WIN RATE</div>' +
            '<div style="font-size:18px;font-weight:700;color:' + wrColor + ';margin-top:2px;">' + wr + '%</div>' +
          '</div>' +
          '<div style="background:var(--card);padding:10px 8px;text-align:center;">' +
            '<div style="font-size:9px;color:var(--text-dim);letter-spacing:1px;">RECORD</div>' +
            '<div style="font-size:16px;font-weight:700;margin-top:2px;">' +
              '<span style="color:var(--green);">' + (d.wins || 0) + 'W</span>' +
              '<span style="color:var(--text-dim);margin:0 3px;">/</span>' +
              '<span style="color:var(--red);">' + (d.losses || 0) + 'L</span>' +
            '</div>' +
          '</div>' +
          '<div style="background:var(--card);padding:10px 8px;text-align:center;">' +
            '<div style="font-size:9px;color:var(--text-dim);letter-spacing:1px;">BEST TRADE</div>' +
            '<div style="font-size:16px;font-weight:700;color:var(--green);margin-top:2px;">+$' + (d.biggestWin || 0).toFixed(2) + '</div>' +
          '</div>' +
          '<div style="background:var(--card);padding:10px 8px;text-align:center;">' +
            '<div style="font-size:9px;color:var(--text-dim);letter-spacing:1px;">TOTAL P/L</div>' +
            '<div style="font-size:16px;font-weight:700;color:' + plColor + ';margin-top:2px;">' +
              (totalPL >= 0 ? '+' : '') + '$' + totalPL.toFixed(2) + '</div>' +
          '</div>' +
        '</div>' +
        // Footer — pushed to bottom via margin-top:auto
        '<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 4px 0;margin-top:auto;">' +
          '<span style="font-size:10px;color:var(--green);opacity:0.7;">' + (d.marketsTraded || 0) + ' markets traded</span>' +
          '<span style="font-size:10px;color:var(--yellow);opacity:0.8;">' + (d.positions?.length || 0) + ' open</span>' +
        '</div>';
    } else {
      pc.innerHTML = '<div style="color:var(--text-dim);">No profile data</div>';
    }

    // Activity feed
    const ac = document.getElementById('activity-content');
    if (d.activity?.length > 0) {
      const typeIcons = { TRADE: '&#x25B6;', REDEEM: '&#x2713;', SPLIT: '&#x2194;', MERGE: '&#x21C4;', REWARD: '&#x2605;', MAKER_REBATE: '&#x267B;' };
      const typeColors = { TRADE: 'var(--green)', REDEEM: 'var(--yellow)', SPLIT: 'var(--text-dim)', MERGE: 'var(--text-dim)', REWARD: 'var(--green)', MAKER_REBATE: 'var(--green)' };
      ac.innerHTML = d.activity.map(a => {
        const time = new Date(a.timestamp * 1000).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
        const date = new Date(a.timestamp * 1000).toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit' });
        const icon = typeIcons[a.type] || '&#x25CF;';
        const color = a.type === 'TRADE' ? (a.side === 'BUY' ? 'var(--green)' : 'var(--red)') : (typeColors[a.type] || 'var(--text-dim)');
        const label = a.type === 'TRADE' ? a.side : a.type;
        const title = (a.title || '').replace(/Bitcoin Up or Down - /g, 'BTC ').slice(0, 30);
        return '<div style="display:flex;justify-content:space-between;align-items:center;padding:3px 0;border-bottom:1px solid var(--border);">' +
          '<div style="display:flex;align-items:center;gap:4px;min-width:0;">' +
            '<span style="color:' + color + ';">' + icon + '</span>' +
            '<span style="color:' + color + ';font-weight:700;white-space:nowrap;">' + label + '</span>' +
            '<span style="color:var(--text-dim);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + title + '</span>' +
          '</div>' +
          '<div style="text-align:right;white-space:nowrap;margin-left:8px;">' +
            '<span>$' + (a.usdcSize || 0).toFixed(2) + '</span>' +
            '<span style="color:var(--text-dim);margin-left:4px;">' + date + ' ' + time + '</span>' +
          '</div>' +
        '</div>';
      }).join('');
    } else {
      ac.innerHTML = '<div style="color:var(--text-dim);text-align:center;padding:10px 0;">No activity</div>';
    }
  } catch (e) {
    console.error('[profile]', e);
  }
}

// ===== TOAST =====
function toast(msg, isError) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'toast show' + (isError ? ' error' : '');
  setTimeout(() => el.className = 'toast', 3000);
}

// ===== TICKER MARQUEE =====
let tickerBotItems = [];
let tickerBrainItems = [];

async function loadTickerData() {
  try {
    const [botRes, brainRes] = await Promise.all([
      fetch(API + '/api/bot-messages').then(r => r.json()).catch(() => ({ messages: [] })),
      fetch(API + '/api/brain/status').then(r => r.json()).catch(() => null)
    ]);
    if (brainRes?.memory) {
      brainRes.memory = adjustBrainMemory(brainRes.memory);
    }

    const colors = { info:'#00ff41', warn:'#ffaa00', error:'#ff3333', trade:'#00ff41' };
    const icons = { info:'\u2139', warn:'\u26A0', error:'\u2717', trade:'\u26A1' };

    if (botRes.messages?.length) {
      tickerBotItems = botRes.messages.slice().reverse().slice(0, 10).map(function(m) {
        const time = new Date(m.ts).toLocaleTimeString('en-GB', { hour:'2-digit', minute:'2-digit' });
        const c = colors[m.type] || '#8b949e';
        const ic = icons[m.type] || '\u25CF';
        return '<span class="ticker-item"><span style="color:' + c + ';">' + ic + '</span> ' +
          '<span style="color:#c9d1d9;">' + m.text + '</span>' +
          ' <span style="color:#8b949e;font-size:9px;">' + time + '</span></span>';
      });
    }

    if (brainRes?.memory) {
      const m = brainRes.memory;
      const id = brainRes.identity || {};
      const wr = parseFloat(m.winRate) || 0;
      const totalPnl = parseFloat(String(m.totalPnl).replace('$','')) || 0;
      const todayPnl = parseFloat(String(m.todayPnl).replace('$','')) || 0;
      const streak = m.currentStreak || 0;
      const wrColor = wr >= 52 ? '#00ff41' : wr >= 48 ? '#ffaa00' : '#ff3333';
      const pnlColor = totalPnl >= 0 ? '#00ff41' : '#ff3333';

      tickerBrainItems = [
        '<span class="ticker-item">\uD83E\uDDE0 <span style="color:#00ff41;font-weight:700;">' + (id.stage || '?') + '</span> max $' + (id.maxBetUsd || '?') + ' · Kelly ' + ((id.kellyFraction||0)*100).toFixed(0) + '%</span>',
        '<span class="ticker-item">WR <span style="color:' + wrColor + ';font-weight:700;">' + m.winRate + '</span></span>',
        '<span class="ticker-item">RECORD <span style="color:#00ff41;">' + m.wins + 'W</span>/<span style="color:#ff3333;">' + m.losses + 'L</span></span>',
        '<span class="ticker-item">P/L <span style="color:' + pnlColor + ';font-weight:700;">' + m.totalPnl + '</span></span>',
        '<span class="ticker-item">TODAY <span style="color:' + (todayPnl >= 0 ? '#00ff41' : '#ff3333') + ';">' + m.todayPnl + '</span></span>',
        '<span class="ticker-item">BEST <span style="color:#00ff41;">+' + m.bestTrade + '</span></span>',
        '<span class="ticker-item">WORST <span style="color:#ff3333;">' + m.worstTrade + '</span></span>',
        '<span class="ticker-item">' + (streak >= 0 ? '\uD83D\uDD25' : '\u2744\uFE0F') + ' STREAK <span style="color:' + (streak >= 0 ? '#00ff41' : '#ff3333') + ';">' + (streak >= 0 ? '+' : '') + streak + '</span></span>',
        '<span class="ticker-item">TRADES ' + m.totalTrades + ' <span style="color:#8b949e;">(' + m.todayTrades + ' today)</span></span>'
      ];
    }

    buildTicker();
  } catch(e) {}
}

function buildTicker() {
  const track = document.getElementById('ticker-track');
  const sep = '<span class="ticker-sep">|</span>';

  const brainStr = tickerBrainItems.join(sep);
  const botStr = tickerBotItems.join(sep);

  let content = '';
  if (brainStr) content += brainStr;
  if (brainStr && botStr) content += '<span class="ticker-sep" style="margin:0 24px;color:rgba(0,255,65,0.15);">///</span>';
  if (botStr) content += botStr;

  if (!content) {
    content = '<span class="ticker-item" style="color:#8b949e;">\uD83E\uDDE0 Loading brain... \uD83E\uDD16 Connecting bot...</span>';
  }

  const doubled = content + '<span style="display:inline-block;width:80px;"></span>' + content + '<span style="display:inline-block;width:80px;"></span>';
  track.innerHTML = doubled;

  const charCount = (brainStr + botStr).replace(/<[^>]*>/g, '').length;
  const speed = Math.max(30, Math.min(90, charCount * 0.12));
  track.parentElement.style.setProperty('--ticker-speed', speed + 's');
}

// ===== INIT =====
initChart();
loadChartData();
connectBtcWs();
loadDashboard();
loadMarkets();
loadProfile();
loadTickerData();

chartRefreshTimer = setInterval(loadChartData, IV_REFRESH[currentInterval]);
setInterval(loadDashboard, 15000);
setInterval(loadMarkets, 30000);
setInterval(loadProfile, 60000);
setInterval(loadTickerData, 10000);

window.addEventListener('resize', () => {
  if (chart) chart.applyOptions({ width: document.getElementById('chart-container').clientWidth });
});
</script>
</body>
</html>
